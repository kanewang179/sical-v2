pipeline {
    agent any
    
    environment {
        // Docker-only ç¯å¢ƒé…ç½®
        PROJECT_NAME = 'sical'
        FRONTEND_IMAGE = 'sical-frontend'
        REGISTRY_URL = 'localhost:5000'
        KUBE_NAMESPACE = 'sical'
        CLUSTER_NAME = 'sical-cluster'
        
        // GitHubä»“åº“é…ç½®ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼‰
        GITHUB_REPO = env.GITHUB_REPO ?: 'https://github.com/kanewang179/sical.git'
        GITHUB_BRANCH = 'main'
        
        // Docker ç½‘ç»œ
        DOCKER_NETWORK = 'sical-docker-only-network'
        
        // æ„å»ºé…ç½®
        NODE_VERSION = '18'
        BUILD_TIMESTAMP = "${new Date().format('yyyyMMdd-HHmmss')}"
        IMAGE_TAG = "${REGISTRY_URL}/${FRONTEND_IMAGE}:${BUILD_TIMESTAMP}"
        LATEST_TAG = "${REGISTRY_URL}/${FRONTEND_IMAGE}:latest"
    }
    
    options {
        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // è¶…æ—¶è®¾ç½®
        timeout(time: 30, unit: 'MINUTES')
        // æ—¶é—´æˆ³
        timestamps()
        // ç¦ç”¨å¹¶å‘æ„å»º
        disableConcurrentBuilds()
    }
    
    triggers {
        // GitHub webhook è§¦å‘
        githubPush()
        // å®šæ—¶æ£€æŸ¥ SCM å˜æ›´ï¼ˆæ¯5åˆ†é’Ÿï¼‰
        pollSCM('H/5 * * * *')
    }
    
    stages {
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                script {
                    echo "ğŸ” æ£€æŸ¥Docker-onlyç¯å¢ƒ..."
                    
                    // æ£€æŸ¥Docker
                    sh 'docker --version'
                    sh 'docker-compose --version'
                    
                    // æ£€æŸ¥ç½‘ç»œè¿æ¥
                    sh '''
                        if ! docker network ls | grep -q "${DOCKER_NETWORK}"; then
                            echo "âŒ Dockerç½‘ç»œ ${DOCKER_NETWORK} ä¸å­˜åœ¨"
                            exit 1
                        fi
                        echo "âœ… Dockerç½‘ç»œæ£€æŸ¥é€šè¿‡"
                    '''
                    
                    // æ£€æŸ¥Registry
                    sh '''
                        if ! curl -f http://${REGISTRY_URL}/v2/ >/dev/null 2>&1; then
                            echo "âŒ Docker Registry ${REGISTRY_URL} ä¸å¯ç”¨"
                            exit 1
                        fi
                        echo "âœ… Docker Registryæ£€æŸ¥é€šè¿‡"
                    '''
                    
                    // æ£€æŸ¥Kindé›†ç¾¤
                    sh '''
                        if ! docker exec sical-docker-only-kind-cluster-1 kubectl get nodes >/dev/null 2>&1; then
                            echo "âŒ Kindé›†ç¾¤ä¸å¯ç”¨"
                            exit 1
                        fi
                        echo "âœ… Kindé›†ç¾¤æ£€æŸ¥é€šè¿‡"
                    '''
                }
            }
        }
        
        stage('ä»£ç æ£€å‡º') {
            steps {
                script {
                    echo "ğŸ“¥ æ£€å‡ºä»£ç ..."
                    
                    // æ¸…ç†å·¥ä½œç©ºé—´
                    cleanWs()
                    
                    // æ£€å‡ºä»£ç 
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: "*/${GITHUB_BRANCH}"]],
                        doGenerateSubmoduleConfigurations: false,
                        extensions: [[
                            $class: 'CleanBeforeCheckout'
                        ]],
                        submoduleCfg: [],
                        userRemoteConfigs: [[
                            url: "${GITHUB_REPO}"
                        ]]
                    ])
                    
                    // æ˜¾ç¤ºæäº¤ä¿¡æ¯
                    sh '''
                        echo "ğŸ“‹ å½“å‰æäº¤ä¿¡æ¯:"
                        git log -1 --pretty=format:"æäº¤: %H%nä½œè€…: %an <%ae>%næ—¶é—´: %ad%næ¶ˆæ¯: %s" --date=format:"%Y-%m-%d %H:%M:%S"
                    '''
                }
            }
        }
        
        stage('å‰ç«¯æµ‹è¯•') {
            steps {
                script {
                    echo "ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•..."
                    
                    dir('frontend') {
                        // åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œæµ‹è¯•
                        sh '''
                            docker run --rm \
                                --network ${DOCKER_NETWORK} \
                                -v "${WORKSPACE}/frontend:/app" \
                                -w /app \
                                node:${NODE_VERSION}-alpine \
                                sh -c "
                                    echo 'ğŸ“¦ å®‰è£…ä¾èµ–...' && \
                                    npm ci && \
                                    echo 'ğŸ§ª è¿è¡Œæµ‹è¯•...' && \
                                    npm run test:ci
                                "
                        '''
                    }
                }
            }
            post {
                always {
                    // å‘å¸ƒæµ‹è¯•ç»“æœ
                    publishTestResults testResultsPattern: 'frontend/test-results.xml'
                }
            }
        }
        
        stage('å‰ç«¯æ„å»º') {
            steps {
                script {
                    echo "ğŸ—ï¸ æ„å»ºå‰ç«¯åº”ç”¨..."
                    
                    dir('frontend') {
                        // åœ¨Dockerå®¹å™¨ä¸­æ„å»º
                        sh '''
                            docker run --rm \
                                --network ${DOCKER_NETWORK} \
                                -v "${WORKSPACE}/frontend:/app" \
                                -w /app \
                                node:${NODE_VERSION}-alpine \
                                sh -c "
                                    echo 'ğŸ“¦ å®‰è£…ä¾èµ–...' && \
                                    npm ci && \
                                    echo 'ğŸ—ï¸ æ„å»ºåº”ç”¨...' && \
                                    npm run build
                                "
                        '''
                        
                        // éªŒè¯æ„å»ºç»“æœ
                        sh '''
                            if [ ! -d "dist" ]; then
                                echo "âŒ æ„å»ºå¤±è´¥ï¼šdistç›®å½•ä¸å­˜åœ¨"
                                exit 1
                            fi
                            echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
                        '''
                    }
                }
            }
        }
        
        stage('Dockeré•œåƒæ„å»º') {
            steps {
                script {
                    echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
                    
                    dir('frontend') {
                        // æ„å»ºDockeré•œåƒ
                        sh '''
                            echo "ğŸ—ï¸ æ„å»ºé•œåƒ: ${IMAGE_TAG}"
                            docker build -t "${IMAGE_TAG}" -t "${LATEST_TAG}" .
                            
                            echo "ğŸ“‹ é•œåƒä¿¡æ¯:"
                            docker images | grep "${FRONTEND_IMAGE}"
                        '''
                        
                        // æ¨é€åˆ°æœ¬åœ°Registry
                        sh '''
                            echo "ğŸ“¤ æ¨é€é•œåƒåˆ°Registry..."
                            docker push "${IMAGE_TAG}"
                            docker push "${LATEST_TAG}"
                            
                            echo "âœ… é•œåƒæ¨é€å®Œæˆ"
                        '''
                        
                        // ä¿å­˜é•œåƒä¿¡æ¯
                        sh '''
                            echo "${IMAGE_TAG}" > "${WORKSPACE}/image-tag.txt"
                            echo "æ„å»ºæ—¶é—´: $(date)" > "${WORKSPACE}/build-info.txt"
                            echo "æäº¤å“ˆå¸Œ: $(git rev-parse HEAD)" >> "${WORKSPACE}/build-info.txt"
                            echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}" >> "${WORKSPACE}/build-info.txt"
                        '''
                    }
                }
            }
        }
        
        stage('Kuberneteséƒ¨ç½²') {
            steps {
                script {
                    echo "â˜¸ï¸ éƒ¨ç½²åˆ°Kubernetes..."
                    
                    // ä½¿ç”¨kubectlå·¥å…·å®¹å™¨éƒ¨ç½²
                    sh '''
                        # åˆ›å»ºä¸´æ—¶éƒ¨ç½²è„šæœ¬
                        cat > deploy-temp.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°Kubernetes..."

# æ£€æŸ¥kubectlè¿æ¥
if ! kubectl get nodes >/dev/null 2>&1; then
    echo "âŒ æ— æ³•è¿æ¥åˆ°Kubernetesé›†ç¾¤"
    exit 1
fi

# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace ${KUBE_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

# åº”ç”¨Kubernetesèµ„æº
echo "ğŸ“‹ åº”ç”¨Kubernetesèµ„æº..."

# æ›´æ–°éƒ¨ç½²é•œåƒ
if kubectl get deployment frontend-deployment -n ${KUBE_NAMESPACE} >/dev/null 2>&1; then
    echo "ğŸ”„ æ›´æ–°ç°æœ‰éƒ¨ç½²..."
    kubectl set image deployment/frontend-deployment frontend=${IMAGE_TAG} -n ${KUBE_NAMESPACE}
else
    echo "ğŸ†• åˆ›å»ºæ–°éƒ¨ç½²..."
    # è¿™é‡Œåº”ç”¨Kubernetesèµ„æºæ–‡ä»¶
    find /workspace/deployment/k8s -name "*.yaml" -exec kubectl apply -f {} -n ${KUBE_NAMESPACE} \;
fi

# ç­‰å¾…éƒ¨ç½²å®Œæˆ
echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
kubectl rollout status deployment/frontend-deployment -n ${KUBE_NAMESPACE} --timeout=300s

# éªŒè¯éƒ¨ç½²
echo "âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€..."
kubectl get pods -n ${KUBE_NAMESPACE}
kubectl get services -n ${KUBE_NAMESPACE}

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
EOF

                        chmod +x deploy-temp.sh
                        
                        # åœ¨kubectlå·¥å…·å®¹å™¨ä¸­æ‰§è¡Œéƒ¨ç½²
                        docker run --rm \
                            --network ${DOCKER_NETWORK} \
                            -v "${WORKSPACE}:/workspace" \
                            -v "/var/run/docker.sock:/var/run/docker.sock" \
                            -e IMAGE_TAG="${IMAGE_TAG}" \
                            -e KUBE_NAMESPACE="${KUBE_NAMESPACE}" \
                            sical-kubectl-tools:latest \
                            /workspace/deploy-temp.sh
                        
                        rm -f deploy-temp.sh
                    '''
                }
            }
        }
        
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                script {
                    echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
                    
                    // å¥åº·æ£€æŸ¥
                    sh '''
                        # æ£€æŸ¥PodçŠ¶æ€
                        docker exec sical-docker-only-kind-cluster-1 kubectl get pods -n ${KUBE_NAMESPACE}
                        
                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        docker exec sical-docker-only-kind-cluster-1 kubectl get services -n ${KUBE_NAMESPACE}
                        
                        # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
                        docker exec sical-docker-only-kind-cluster-1 kubectl get deployments -n ${KUBE_NAMESPACE}
                        
                        echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ“Š æ„å»ºåå¤„ç†..."
                
                // å½’æ¡£æ„å»ºäº§ç‰©
                archiveArtifacts artifacts: 'image-tag.txt,build-info.txt', allowEmptyArchive: true
                
                // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                sh 'rm -f deploy-temp.sh'
            }
        }
        
        success {
            script {
                echo "ğŸ‰ Docker-only éƒ¨ç½²æˆåŠŸï¼"
                
                // å‘é€æˆåŠŸé€šçŸ¥
                sh '''
                    echo "ğŸ“§ å‘é€æˆåŠŸé€šçŸ¥..."
                    echo "æ„å»º #${BUILD_NUMBER} éƒ¨ç½²æˆåŠŸ" > success-notification.txt
                    echo "é•œåƒæ ‡ç­¾: ${IMAGE_TAG}" >> success-notification.txt
                    echo "éƒ¨ç½²æ—¶é—´: $(date)" >> success-notification.txt
                    echo "è®¿é—®åœ°å€: é€šè¿‡Kubernetes Ingress" >> success-notification.txt
                '''
            }
        }
        
        failure {
            script {
                echo "âŒ Docker-only éƒ¨ç½²å¤±è´¥ï¼"
                
                // æ”¶é›†é”™è¯¯ä¿¡æ¯
                sh '''
                    echo "ğŸ“‹ æ”¶é›†é”™è¯¯ä¿¡æ¯..."
                    
                    # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                    docker ps -a | grep sical || true
                    
                    # æ£€æŸ¥KubernetesçŠ¶æ€
                    docker exec sical-docker-only-kind-cluster-1 kubectl get pods -A || true
                    
                    # æ”¶é›†æ—¥å¿—
                    docker logs sical-docker-only-kind-cluster-1 --tail=50 || true
                '''
            }
        }
        
        cleanup {
            script {
                echo "ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´..."
                
                // æ¸…ç†Dockeré•œåƒï¼ˆä¿ç•™æœ€æ–°çš„ï¼‰
                sh '''
                    # æ¸…ç†æ—§çš„æ„å»ºé•œåƒ
                    docker images | grep "${FRONTEND_IMAGE}" | grep -v "latest" | tail -n +6 | awk '{print $3}' | xargs -r docker rmi || true
                '''
                
                // æ¸…ç†å·¥ä½œç©ºé—´
                cleanWs()
            }
        }
    }
}