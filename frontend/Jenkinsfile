pipeline {
    agent any
    
    environment {
        // Docker Registryé…ç½®
        DOCKER_REGISTRY = 'localhost:5000'
        IMAGE_NAME = 'sical-frontend'
        IMAGE_TAG = "${BUILD_NUMBER}"
        FULL_IMAGE_NAME = "${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        
        // Kubernetesé…ç½®
        KUBECONFIG_CREDENTIAL_ID = 'kubeconfig'
        NAMESPACE = 'default'
        
        // Node.jsç‰ˆæœ¬
        NODE_VERSION = '18'
    }
    
    stages {
        stage('ä»£ç æ‹‰å–') {
            steps {
                echo 'å¼€å§‹æ‹‰å–ä»£ç ...'
                checkout scm
                
                script {
                    // è·å–Gitæäº¤ä¿¡æ¯
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    
                    env.GIT_BRANCH = sh(
                        script: 'git rev-parse --abbrev-ref HEAD',
                        returnStdout: true
                    ).trim()
                    
                    echo "Gitæäº¤: ${env.GIT_COMMIT_SHORT}"
                    echo "Gitåˆ†æ”¯: ${env.GIT_BRANCH}"
                }
            }
        }
        
        stage('ç¯å¢ƒå‡†å¤‡') {
            steps {
                echo 'å‡†å¤‡Node.jsç¯å¢ƒ...'
                dir('frontend') {
                    sh '''
                        # æ£€æŸ¥Node.jsç‰ˆæœ¬
                        node --version
                        npm --version
                        
                        # æ¸…ç†ç¼“å­˜
                        npm cache clean --force
                    '''
                }
            }
        }
        
        stage('ä¾èµ–å®‰è£…') {
            steps {
                echo 'å®‰è£…å‰ç«¯ä¾èµ–...'
                dir('frontend') {
                    sh '''
                        # å®‰è£…ä¾èµ–
                        npm ci --production=false
                        
                        # éªŒè¯å…³é”®ä¾èµ–
                        npm list --depth=0
                    '''
                }
            }
        }
        
        stage('ä»£ç æ£€æŸ¥') {
            steps {
                echo 'è¿›è¡Œä»£ç è´¨é‡æ£€æŸ¥...'
                dir('frontend') {
                    script {
                        try {
                            sh 'npx tsc --noEmit || true'
                            echo "TypeScriptæ£€æŸ¥å®Œæˆ"
                        } catch (Exception e) {
                            echo "TypeScriptæ£€æŸ¥å®Œæˆï¼Œå­˜åœ¨ç±»å‹é”™è¯¯"
                        }
                    }
                }
            }
        }
        
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                echo 'è¿è¡Œå•å…ƒæµ‹è¯•...'
                dir('frontend') {
                    script {
                        try {
                            sh 'npm run test:run || true'
                        } catch (Exception e) {
                            echo "å•å…ƒæµ‹è¯•å®Œæˆï¼Œå¯èƒ½å­˜åœ¨å¤±è´¥çš„æµ‹è¯•"
                        }
                    }
                }
            }
        }
        
        stage('æ„å»ºå‰ç«¯') {
            steps {
                echo 'æ„å»ºå‰ç«¯åº”ç”¨...'
                dir('frontend') {
                    sh '''
                        # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
                        npm run build
                        
                        # æ£€æŸ¥æ„å»ºç»“æœ
                        ls -la dist/
                        du -sh dist/
                    '''
                }
            }
        }
        
        stage('æ„å»ºDockeré•œåƒ') {
            steps {
                echo "æ„å»ºDockeré•œåƒ: ${FULL_IMAGE_NAME}"
                dir('frontend') {
                    script {
                        // åˆ›å»ºDockerfileï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                        if (!fileExists('Dockerfile')) {
                            writeFile file: 'Dockerfile', text: '''
# å¤šé˜¶æ®µæ„å»º
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶nginxé…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost/ || exit 1

CMD ["nginx", "-g", "daemon off;"]
'''
                        }
                        
                        // æ„å»ºé•œåƒ
                        sh "docker build -t ${FULL_IMAGE_NAME} ."
                        
                        // éªŒè¯é•œåƒ
                        sh "docker images | grep ${IMAGE_NAME}"
                    }
                }
            }
        }
        
        stage('æ¨é€é•œåƒ') {
            steps {
                echo "æ¨é€é•œåƒåˆ°Registry: ${DOCKER_REGISTRY}"
                script {
                    sh "docker push ${FULL_IMAGE_NAME}"
                    
                    // æ ‡è®°latestç‰ˆæœ¬ï¼ˆä»…ä¸»åˆ†æ”¯ï¼‰
                    if (env.GIT_BRANCH == 'main' || env.GIT_BRANCH == 'master') {
                        sh "docker tag ${FULL_IMAGE_NAME} ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest"
                        sh "docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest"
                    }
                    
                    echo "é•œåƒæ¨é€å®Œæˆ: ${FULL_IMAGE_NAME}"
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°Kubernetes') {
            steps {
                echo 'éƒ¨ç½²å‰ç«¯åº”ç”¨åˆ°Kubernetes...'
                script {
                    // åˆ›å»ºKuberneteséƒ¨ç½²æ–‡ä»¶
                    def k8sManifest = """
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sical-frontend
  namespace: ${NAMESPACE}
  labels:
    app: sical-frontend
    version: "${IMAGE_TAG}"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: sical-frontend
  template:
    metadata:
      labels:
        app: sical-frontend
        version: "${IMAGE_TAG}"
    spec:
      containers:
      - name: frontend
        image: ${FULL_IMAGE_NAME}
        ports:
        - containerPort: 80
          name: http
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
        env:
        - name: NODE_ENV
          value: "production"
---
apiVersion: v1
kind: Service
metadata:
  name: sical-frontend-service
  namespace: ${NAMESPACE}
  labels:
    app: sical-frontend
spec:
  selector:
    app: sical-frontend
  ports:
  - port: 80
    targetPort: 80
    name: http
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sical-frontend-ingress
  namespace: ${NAMESPACE}
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: sical-frontend.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: sical-frontend-service
            port:
              number: 80
"""
                    
                    // å†™å…¥ä¸´æ—¶æ–‡ä»¶
                    writeFile file: 'k8s-deployment.yaml', text: k8sManifest
                    
                    // ä½¿ç”¨kubectléƒ¨ç½²
                    withCredentials([kubeconfigFile(credentialsId: KUBECONFIG_CREDENTIAL_ID, variable: 'KUBECONFIG')]) {
                        sh '''
                            # éªŒè¯kubectlè¿æ¥
                            kubectl cluster-info
                            
                            # åˆ›å»ºå‘½åç©ºé—´ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                            kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                            
                            # åº”ç”¨éƒ¨ç½²é…ç½®
                            kubectl apply -f k8s-deployment.yaml
                            
                            # ç­‰å¾…éƒ¨ç½²å®Œæˆ
                            kubectl rollout status deployment/sical-frontend -n ${NAMESPACE} --timeout=300s
                            
                            # éªŒè¯éƒ¨ç½²çŠ¶æ€
                            kubectl get pods -n ${NAMESPACE} -l app=sical-frontend
                            kubectl get services -n ${NAMESPACE} -l app=sical-frontend
                            kubectl get ingress -n ${NAMESPACE}
                        '''
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                echo 'éªŒè¯éƒ¨ç½²çŠ¶æ€...'
                script {
                    withCredentials([kubeconfigFile(credentialsId: KUBECONFIG_CREDENTIAL_ID, variable: 'KUBECONFIG')]) {
                        sh '''
                            # æ£€æŸ¥PodçŠ¶æ€
                            echo "=== PodçŠ¶æ€ ==="
                            kubectl get pods -n ${NAMESPACE} -l app=sical-frontend -o wide
                            
                            # æ£€æŸ¥ServiceçŠ¶æ€
                            echo "=== ServiceçŠ¶æ€ ==="
                            kubectl get svc -n ${NAMESPACE} -l app=sical-frontend
                            
                            # æ£€æŸ¥IngressçŠ¶æ€
                            echo "=== IngressçŠ¶æ€ ==="
                            kubectl get ingress -n ${NAMESPACE}
                            
                            # è·å–åº”ç”¨æ—¥å¿—
                            echo "=== åº”ç”¨æ—¥å¿— ==="
                            kubectl logs -n ${NAMESPACE} -l app=sical-frontend --tail=20 || true
                            
                            # ç«¯å£è½¬å‘æµ‹è¯•ï¼ˆåå°è¿è¡Œï¼‰
                            echo "=== è¿æ¥æµ‹è¯• ==="
                            timeout 10s kubectl port-forward -n ${NAMESPACE} svc/sical-frontend-service 8081:80 &
                            sleep 5
                            curl -f http://localhost:8081/ || echo "è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†éƒ¨ç½²å¯èƒ½ä»ç„¶æˆåŠŸ"
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'æ¸…ç†å·¥ä½œç©ºé—´...'
            
            // æ¸…ç†Dockeré•œåƒï¼ˆä¿ç•™æœ€æ–°çš„å‡ ä¸ªç‰ˆæœ¬ï¼‰
            script {
                try {
                    sh '''
                        # æ¸…ç†æ—§çš„é•œåƒï¼ˆä¿ç•™æœ€æ–°5ä¸ªç‰ˆæœ¬ï¼‰
                        docker images ${DOCKER_REGISTRY}/${IMAGE_NAME} --format "table {{.Tag}}\t{{.ID}}" | 
                        tail -n +2 | sort -nr | tail -n +6 | awk '{print $2}' | 
                        xargs -r docker rmi || true
                    '''
                } catch (Exception e) {
                    echo "æ¸…ç†Dockeré•œåƒæ—¶å‡ºç°é”™è¯¯: ${e.getMessage()}"
                }
            }
            
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sh 'rm -f k8s-deployment.yaml || true'
            
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
        }
        
        success {
            echo "ğŸ‰ å‰ç«¯éƒ¨ç½²æˆåŠŸï¼"
            echo "é•œåƒ: ${FULL_IMAGE_NAME}"
            echo "Gitæäº¤: ${env.GIT_COMMIT_SHORT}"
            echo "è®¿é—®åœ°å€: http://sical-frontend.local (éœ€è¦é…ç½®hosts)"
            
            // å‘é€æˆåŠŸé€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†Slackç­‰ï¼‰
            script {
                try {
                    // slackSend channel: '#deployments', 
                    //           color: 'good',
                    //           message: "âœ… SiCalå‰ç«¯éƒ¨ç½²æˆåŠŸ\né•œåƒ: ${FULL_IMAGE_NAME}\nGit: ${env.GIT_COMMIT_SHORT}"
                } catch (Exception e) {
                    echo "å‘é€é€šçŸ¥å¤±è´¥: ${e.getMessage()}"
                }
            }
        }
        
        failure {
            echo "âŒ å‰ç«¯éƒ¨ç½²å¤±è´¥ï¼"
            
            // æ”¶é›†é”™è¯¯ä¿¡æ¯
            script {
                try {
                    sh '''
                        echo "=== æ„å»ºå¤±è´¥ä¿¡æ¯æ”¶é›† ==="
                        
                        # Dockerä¿¡æ¯
                        echo "Dockeré•œåƒ:"
                        docker images | grep ${IMAGE_NAME} || true
                        
                        # KubernetesçŠ¶æ€
                        echo "KubernetesçŠ¶æ€:"
                        kubectl get pods -n ${NAMESPACE} -l app=sical-frontend || true
                        kubectl describe pods -n ${NAMESPACE} -l app=sical-frontend || true
                    '''
                } catch (Exception e) {
                    echo "æ”¶é›†é”™è¯¯ä¿¡æ¯å¤±è´¥: ${e.getMessage()}"
                }
            }
            
            // å‘é€å¤±è´¥é€šçŸ¥
            script {
                try {
                    // slackSend channel: '#deployments', 
                    //           color: 'danger',
                    //           message: "âŒ SiCalå‰ç«¯éƒ¨ç½²å¤±è´¥\næ„å»º: ${BUILD_URL}\nGit: ${env.GIT_COMMIT_SHORT}"
                } catch (Exception e) {
                    echo "å‘é€é€šçŸ¥å¤±è´¥: ${e.getMessage()}"
                }
            }
        }
        
        unstable {
            echo "âš ï¸ å‰ç«¯éƒ¨ç½²ä¸ç¨³å®šï¼"
        }
    }
}